"""
Auteur:
    - Boris Sanchot, Data Scientist Senior chez StarClay
    - Quillivic Robin, Data Scientist chez StarClay, 07 69 70 64 95 / rquilivic@starclay.fr

Description: 
    Fichier qui permet de nettoyer des données textuelles: 
        - gestion des erreures de frappes fréquentes
        - gestion des nombres
        - gestion de la ponctuation
        - liste de stop_words exhaustive
"""

import re
import string


# Constructed with analysis of embedding coverage
misspell_dict = {"cest": "c'est",
                 "controlaterale": "controlatérale",
                 '\x9cdème': "oedème",
                 '\x9cdèmes': "oedèmes",
                 'léchographie': "échographie",
                 "desaturation": "désaturation",
                 '\x9cil': "oeil",
                 "limplant": "implant",
                 "hemorragiques": "hémorragiques",
                 "hypoglycemie": "hypoglycémie",
                 "lautomate": 'automate',
                 'l\x9cil': 'oeil',
                 'adenopathie': 'adénopathie',
                 'prothetique': 'prothétique',
                 'inapproprie': "inapproprié",
                 'lartère': 'artère',
                 'asthenie': 'asthénie',
                 'man\x9cuvre': 'manoeuvre',
                 'lexplantation': 'explantation',
                 'lymphoree': 'lymphorée',
                 'salpyngectomie': 'salpingectomie',
                 'burnaout': 'burnout',
                 'lnterventlon': 'intervention',
                 'pericardique': 'péricardique',
                 'lendométriose': 'endométriose',
                 'daudition': 'audition',
                 'désaltére': 'désaltéré',
                 'cephalee': 'céphalée',
                 'salpaginctomie': 'salpingectomie',
                 'menauposée': 'ménopausée',
                 'deczéma': 'eczéma',
                 'peritonite': 'péritonite',
                 'lablation': 'ablation',
                 'microjyste': 'microkyste',
                 'généralié': 'généralité',
                 'débriété': 'ébriété',
                 'acidocetose': 'acidocétose',
                 'dhéparine': 'héparine',
                 'dincident': 'incident',
                 'daiguille': 'aiguille',
                 'materiovigilance': 'matériovigilance',
                 'adenomyose': 'adénomyose'
                 }


def replace_typical_misspell(text: str) -> (str):
    """Permet de remplacer dans le texte entrée les erreurs fréquentes
    d'après une liste construite ci-dessous

    Args:
        text (str): Le texte à corriger

    Returns:
        str: le texte corrigé
    """
    misspell_re = re.compile('(%s)' % '|'.join(misspell_dict.keys()))

    def replace(match):
        return misspell_dict[match.group(0)]

    return misspell_re.sub(replace, text)


puncts = [',', '.', '"', ':', ')', '(', '-', '!', '?', '|', ';', "'", '$', '&', '/', '[', ']',
          '>', '%', '=', '#', '*', '+', '\\', '•', '~', '@', '£', '·', '_', '{', '}', '©',
          '®', '`', '<', '→', '°', '€', '™', '›', '♥', '←', '×', '§', '″', '′', 'Â', '█',
          '½', '…', '“', '★', '”', '–', '●', 'â', '►', '−', '¢', '²', '¬', '░', '¶',
          '↑', '±', '¿', '▾', '═', '¦', '║', '―', '¥', '▓', '—', '‹', '─', '▒', '：', '¼',
          '⊕', '▼', '▪', '†', '■', '’', '▀', '¨', '▄', '♫', '☆', '¯', '♦', '¤', '▲',
          '¸', '¾', 'Ã', '⋅', '‘', '∞', '∙', '）', '↓', '、', '│', '（', '»', '，', '♪',
          '╩', '╚', '³', '・', '╦', '╣', '╔', '╗', '▬', '❤', 'ï', 'Ø', '¹', '≤', '‡', '√']


bad_char = ['\x85']

carriage = [r"\\t|\\n|\\r", "\t|\n|\r", "\r\r\n"]

apostrohpe = ["d'", "l'", "t'", "s'"]


def clean_text(text: str) -> (str):
    """Permet de nettoyer le texte en entrée: 
        - gestion des espaces
        -gestion de la ponctuation
        - gestion des apostrophes

    Args:
        text (str): texte à nettoyer

    Returns:
        text (str): texte nettoyé
    """
    text = str(text)

    text = text.replace('\x9c', 'oe')
    text = text.replace('\x92', "'")

    for carr in carriage:
        if carr in text:
            text = text.replace(carr, ' ')
    for apos in apostrohpe:
        if apos in text:
            text = text.replace(apos, '')
    for punct in puncts + list(string.punctuation):
        if punct in text:
            text = text.replace(punct, f' {punct} ')
    for bc in bad_char:
        if bc in text:
            text = text.replace(bc, '')

    return text


def clean_numbers(text: str) -> (str):
    """
    Permet de retirer les caratères numérique d'un texte en entrée

    Args:
        text (str): texte avec des chiffres

    Returns:
        text (str): texte sans chiffre
    """
    return re.sub(r'\d+', '', text)


def preprocess_text(text: str) -> (str):
    """
    Fonction réalisant la préparation du texte entièrement:
        - mise en minuscule
        - application de clean_text
        - suppression des caractères numériques
        - gestion des erreurs d'orthographe fréquentes
        - gestion des caractères spéciaux

    Args:
        text (str): texte en entrée

    Returns:
        text (str): texte préparé
    """    
    if isinstance(text, str):
        text = text.lower()
        text = clean_text(text)
        text = clean_numbers(text)
        text = replace_typical_misspell(text)
        text = text.strip()
        text = re.sub(' +', ' ', text)
        text = text.replace("/", '')

    else:
        text = ""
    return text


"""
import pandas as pd
df = pd.read_csv('../../data/train_test/train_toy.csv')
text = df['DESCRIPTION_INCIDENT'].iloc[0]
print(preprocess_text(text))"""


STOP_WORDS = {'a',
              'abord',
              'absolument',
              'afin',
              'ah',
              'ai',
              'aie',
              'ailleurs',
              'ainsi',
              'ait',
              'allaient',
              'allo',
              'allons',
              'allô',
              'alors',
              'anterieur',
              'anterieure',
              'anterieures',
              'apres',
              'après',
              'as',
              'assez',
              'attendu',
              'au',
              'aucun',
              'aucune',
              'aujourd',
              "aujourd'hui",
              'aupres',
              'auquel',
              'aura',
              'auraient',
              'aurait',
              'auront',
              'aussi',
              'autre',
              'autrefois',
              'autrement',
              'autres',
              'autrui',
              'aux',
              'auxquelles',
              'auxquels',
              'avaient',
              'avais',
              'avait',
              'avant',
              'avec',
              'avoir',
              'avons',
              'ayant',
              'bah',
              'bas',
              'basee',
              'bat',
              'beau',
              'beaucoup',
              'bien',
              'bigre',
              'boum',
              'bravo',
              'brrr',
              "c'",
              'car',
              'ce',
              'ceci',
              'cela',
              'celle',
              'celle-ci',
              'celle-là',
              'celles',
              'celles-ci',
              'celles-là',
              'celui',
              'celui-ci',
              'celui-là',
              'cent',
              'cependant',
              'certain',
              'certaine',
              'certaines',
              'certains',
              'certes',
              'ces',
              'cet',
              'cette',
              'ceux',
              'ceux-ci',
              'ceux-là',
              'chacun',
              'chacune',
              'chaque',
              'cher',
              'chers',
              'chez',
              'chiche',
              'chut',
              'chère',
              'chères',
              'ci',
              'cinq',
              'cinquantaine',
              'cinquante',
              'cinquantième',
              'cinquième',
              'clac',
              'clic',
              'combien',
              'comme',
              'comment',
              'comparable',
              'comparables',
              'compris',
              'concernant',
              'contre',
              'couic',
              'crac',
              'c’',
              "d'",
              'da',
              'dans',
              'de',
              'debout',
              'dedans',
              'dehors',
              'deja',
              'delà',
              'depuis',
              'dernier',
              'derniere',
              'derriere',
              'derrière',
              'des',
              'desormais',
              'desquelles',
              'desquels',
              'dessous',
              'dessus',
              'deux',
              'deuxième',
              'deuxièmement',
              'devant',
              'devers',
              'devra',
              'different',
              'differentes',
              'differents',
              'différent',
              'différente',
              'différentes',
              'différents',
              'dire',
              'directe',
              'directement',
              'dit',
              'dite',
              'dits',
              'divers',
              'diverse',
              'diverses',
              'dix',
              'dix-huit',
              'dix-neuf',
              'dix-sept',
              'dixième',
              'doit',
              'doivent',
              'donc',
              'dont',
              'douze',
              'douzième',
              'dring',
              'du',
              'duquel',
              'durant',
              'dès',
              'désormais',
              'd’',
              'effet',
              'egale',
              'egalement',
              'egales',
              'eh',
              'elle',
              'elle-même',
              'elles',
              'elles-mêmes',
              'en',
              'encore',
              'enfin',
              'entre',
              'envers',
              'environ',
              'es',
              'est',
              'et',
              'etaient',
              'etais',
              'etait',
              'etant',
              'etc',
              'etre',
              'eu',
              'euh',
              'eux',
              'eux-mêmes',
              'exactement',
              'excepté',
              'extenso',
              'exterieur',
              'fais',
              'faisaient',
              'faisant',
              'fait',
              'façon',
              'feront',
              'fi',
              'flac',
              'floc',
              'font',
              'gens',
              'ha',
              'hein',
              'hem',
              'hep',
              'hi',
              'ho',
              'holà',
              'hop',
              'hormis',
              'hors',
              'hou',
              'houp',
              'hue',
              'hui',
              'huit',
              'huitième',
              'hum',
              'hurrah',
              'hé',
              'hélas',
              'i',
              'il',
              'ils',
              'importe',
              "j'",
              'je',
              'jusqu',
              'jusque',
              'juste',
              'j’',
              "l'",
              'la',
              'laisser',
              'laquelle',
              'las',
              'le',
              'lequel',
              'les',
              'lesquelles',
              'lesquels',
              'leur',
              'leurs',
              'longtemps',
              'lors',
              'lorsque',
              'lui',
              'lui-meme',
              'lui-même',
              'là',
              'lès',
              'l’',
              "m'",
              'ma',
              'maint',
              'maintenant',
              'mais',
              'malgre',
              'malgré',
              'maximale',
              'me',
              'meme',
              'memes',
              'merci',
              'mes',
              'mien',
              'mienne',
              'miennes',
              'miens',
              'mille',
              'mince',
              'minimale',
              'moi',
              'moi-meme',
              'moi-même',
              'moindres',
              'moins',
              'mon',
              'moyennant',
              'même',
              'mêmes',
              'm’',
              "n'",
              'na',
              'naturel',
              'naturelle',
              'naturelles',
              'ne',
              'neanmoins',
              'necessaire',
              'necessairement',
              'neuf',
              'neuvième',
              'ni',
              'nombreuses',
              'nombreux',
              'non',
              'nos',
              'notamment',
              'notre',
              'nous',
              'nous-mêmes',
              'nouveau',
              'nul',
              'néanmoins',
              'nôtre',
              'nôtres',
              'n’',
              'o',
              'oh',
              'ohé',
              'ollé',
              'olé',
              'on',
              'ont',
              'onze',
              'onzième',
              'ore',
              'ou',
              'ouf',
              'ouias',
              'oust',
              'ouste',
              'outre',
              'ouvert',
              'ouverte',
              'ouverts',
              'où',
              'paf',
              'pan',
              'par',
              'parce',
              'parfois',
              'parle',
              'parlent',
              'parler',
              'parmi',
              'parseme',
              'partant',
              'particulier',
              'particulière',
              'particulièrement',
              'pas',
              'passé',
              'pendant',
              'pense',
              'permet',
              'personne',
              'peu',
              'peut',
              'peuvent',
              'peux',
              'pff',
              'pfft',
              'pfut',
              'pif',
              'pire',
              'plein',
              'plouf',
              'plus',
              'plusieurs',
              'plutôt',
              'possessif',
              'possessifs',
              'possible',
              'possibles',
              'pouah',
              'pour',
              'pourquoi',
              'pourrais',
              'pourrait',
              'pouvait',
              'prealable',
              'precisement',
              'premier',
              'première',
              'premièrement',
              'pres',
              'probable',
              'probante',
              'procedant',
              'proche',
              'près',
              'psitt',
              'pu',
              'puis',
              'puisque',
              'pur',
              'pure',
              "qu'",
              'quand',
              'quant',
              'quant-à-soi',
              'quanta',
              'quarante',
              'quatorze',
              'quatre',
              'quatre-vingt',
              'quatrième',
              'quatrièmement',
              'que',
              'quel',
              'quelconque',
              'quelle',
              'quelles',
              "quelqu'un",
              'quelque',
              'quelques',
              'quels',
              'qui',
              'quiconque',
              'quinze',
              'quoi',
              'quoique',
              'qu’',
              'rare',
              'rarement',
              'rares',
              'relative',
              'relativement',
              'remarquable',
              'rend',
              'rendre',
              'restant',
              'reste',
              'restent',
              'restrictif',
              'retour',
              'revoici',
              'revoilà',
              'rien',
              "s'",
              'sa',
              'sacrebleu',
              'sait',
              'sans',
              'sapristi',
              'sauf',
              'se',
              'sein',
              'seize',
              'selon',
              'semblable',
              'semblaient',
              'semble',
              'semblent',
              'sent',
              'sept',
              'septième',
              'sera',
              'seraient',
              'serait',
              'seront',
              'ses',
              'seul',
              'seule',
              'seulement',
              'si',
              'sien',
              'sienne',
              'siennes',
              'siens',
              'sinon',
              'six',
              'sixième',
              'soi',
              'soi-même',
              'soit',
              'soixante',
              'son',
              'sont',
              'sous',
              'souvent',
              'specifique',
              'specifiques',
              'speculatif',
              'stop',
              'strictement',
              'subtiles',
              'suffisant',
              'suffisante',
              'suffit',
              'suis',
              'suit',
              'suivant',
              'suivante',
              'suivantes',
              'suivants',
              'suivre',
              'superpose',
              'sur',
              'surtout',
              's’',
              "t'",
              'ta',
              'tac',
              'tant',
              'tardive',
              'te',
              'tel',
              'telle',
              'tellement',
              'telles',
              'tels',
              'tenant',
              'tend',
              'tenir',
              'tente',
              'tes',
              'tic',
              'tien',
              'tienne',
              'tiennes',
              'tiens',
              'toc',
              'toi',
              'toi-même',
              'ton',
              'touchant',
              'toujours',
              'tous',
              'tout',
              'toute',
              'toutefois',
              'toutes',
              'treize',
              'trente',
              'tres',
              'trois',
              'troisième',
              'troisièmement',
              'trop',
              'très',
              'tsoin',
              'tsouin',
              'tu',
              'té',
              't’',
              'un',
              'une',
              'unes',
              'uniformement',
              'unique',
              'uniques',
              'uns',
              'va',
              'vais',
              'vas',
              'vers',
              'via',
              'vif',
              'vifs',
              'vingt',
              'vivat',
              'vive',
              'vives',
              'vlan',
              'voici',
              'voilà',
              'vont',
              'vos',
              'votre',
              'vous',
              'vous-mêmes',
              'vu',
              'vé',
              'vôtre',
              'vôtres',
              'zut',
              'à',
              'â',
              'ça',
              'ès',
              'étaient',
              'étais',
              'était',
              'étant',
              'été',
              'être',
              'ô'}
